<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Tracker System</title>
    
    <!-- นำเข้า Tailwind CSS สำหรับจัดหน้า -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ตั้งค่า Import Map เพื่อให้ดึง React และ Icon มาใช้ได้โดยไม่ต้องลงโปรแกรม -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <!-- นำเข้า Babel เพื่อแปลงโค้ด JSX ใน Browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- ปรับแต่ง Font ให้สวยงาม -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- ส่วนของโค้ด React Application -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        // นำเข้าไอคอนทั้งหมดที่ใช้
        import { Camera, Plus, Save, Wrench, Clock, FileText, ChevronLeft, Search, Trash2, MapPin, Tag, ShoppingBag, DollarSign, X, LayoutDashboard, List, BarChart3, AlertTriangle, TrendingUp, Calendar, Folder, Image as ImageIcon, Building2, PlusCircle, Package } from 'lucide-react';

        // --- Mock Data Component (ข้อมูลตัวอย่าง) ---
        const initialData = [
            {
                id: 'EQ-2023-001',
                name: 'MacBook Pro 16"',
                model: 'M1 Pro',
                image: null,
                purchaseDate: '2023-01-15',
                status: 'active',
                location: 'แผนก IT',
                history: [
                    { 
                        id: 1, 
                        date: '2023-06-10', 
                        type: 'repair', 
                        description: 'เปลี่ยนหน้าจอและทำความสะอาด', 
                        laborCost: 1000,
                        parts: [
                            { name: 'Screen Assembly', supplier: 'Apple Care', price: 14000, image: null },
                            { name: 'Thermal Paste', supplier: 'IT Shop', price: 350, image: null }
                        ], 
                        totalCost: 15350 
                    }
                ]
            },
            {
                id: 'EQ-2023-002',
                name: 'เครื่องปรับอากาศ Daikin',
                model: 'FTKQ-12',
                image: null,
                purchaseDate: '2022-05-20',
                status: 'active',
                location: 'ห้อง Server',
                history: [
                    { 
                        id: 2, 
                        date: '2023-08-15', 
                        type: 'repair', 
                        description: 'แอร์ไม่เย็น', 
                        laborCost: 500,
                        parts: [
                            { name: 'Capacitor', supplier: 'ร้านแอร์', price: 450, image: null }
                        ], 
                        totalCost: 950 
                    }
                ]
            },
            {
                id: 'EQ-2023-003',
                name: 'รถโฟล์คลิฟท์ Toyota',
                model: '8FD25',
                image: null,
                purchaseDate: '2020-11-10',
                status: 'active',
                location: 'คลังสินค้า 1',
                history: [
                    { 
                        id: 3, 
                        date: '2023-02-10', 
                        type: 'repair', 
                        description: 'เปลี่ยนยาง', 
                        laborCost: 1000,
                        parts: [
                            { name: 'ยางล้อหน้า', supplier: 'Toyota Parts', price: 4500, image: null }
                        ], 
                        totalCost: 5500 
                    },
                    { 
                        id: 4, 
                        date: '2023-09-20', 
                        type: 'repair', 
                        description: 'เปลี่ยนยางอีกข้าง', 
                        laborCost: 1000,
                        parts: [
                            { name: 'ยางล้อหน้า', supplier: 'Toyota Parts', price: 4500, image: null }
                        ], 
                        totalCost: 5500 
                    }
                ]
            },
            {
                id: 'EQ-2023-004',
                name: 'เครื่องสแกนบาร์โค้ด',
                model: 'Zebra DS2208',
                image: null,
                purchaseDate: '2023-02-01',
                status: 'active',
                location: 'คลังสินค้า 1',
                history: []
            }
        ];

        // --- Main Component ---
        function App() {
            // Navigation State
            const [view, setView] = useState('dashboard'); // dashboard, departments, departmentItems, add, detail
            const [selectedDepartment, setSelectedDepartment] = useState(null);
            
            // Data State
            const [items, setItems] = useState(initialData);
            const [departmentList, setDepartmentList] = useState([...new Set(initialData.map(i => i.location))]);
            
            const [selectedItem, setSelectedItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');

            // Helper: Generate Code
            const generateCode = () => {
                const year = new Date().getFullYear();
                const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                return `EQ-${year}-${random}`;
            };

            // Helper: Calculate Age
            const calculateAge = (dateString) => {
                if (!dateString) return '-';
                const start = new Date(dateString);
                const end = new Date();
                
                let years = end.getFullYear() - start.getFullYear();
                let months = end.getMonth() - start.getMonth();
                let days = end.getDate() - start.getDate();

                if (days < 0) {
                    months--;
                    const prevMonth = new Date(end.getFullYear(), end.getMonth(), 0);
                    days += prevMonth.getDate();
                }
                if (months < 0) {
                    years--;
                    months += 12;
                }
                if (years < 0) return "ยังไม่ถึงวันใช้งาน";

                let result = [];
                if (years > 0) result.push(`${years} ปี`);
                if (months > 0) result.push(`${months} เดือน`);
                return result.length > 0 ? result.join(' ') : 'เพิ่งซื้อ';
            };

            // CRUD Actions
            const handleAddItem = (newItem) => {
                setItems([newItem, ...items]);
                if (newItem.location && !departmentList.includes(newItem.location)) {
                    setDepartmentList([...departmentList, newItem.location]);
                }
                setSelectedDepartment(newItem.location);
                setView('departmentItems');
            };

            const handleUpdateItem = (updatedItem) => {
                const updatedList = items.map(item => item.id === updatedItem.id ? updatedItem : item);
                setItems(updatedList);
                setSelectedItem(updatedItem);
            };

            const deleteItem = (id) => {
                if(confirm('ต้องการลบข้อมูลนี้ใช่หรือไม่?')) {
                    const newItems = items.filter(i => i.id !== id);
                    setItems(newItems);
                    setView('departmentItems');
                    setSelectedItem(null);
                }
            };

            const handleAddDepartment = () => {
                const name = prompt("กรุณาระบุชื่อแผนกใหม่:");
                if (name && name.trim() !== "") {
                    if (!departmentList.includes(name.trim())) {
                        setDepartmentList([...departmentList, name.trim()]);
                    } else {
                        alert("มีแผนกนี้อยู่แล้ว");
                    }
                }
            };

            const deleteDepartment = (deptName, e) => {
                e.stopPropagation();
                const hasItems = items.some(i => i.location === deptName);
                if (hasItems) {
                    alert(`ไม่สามารถลบแผนก "${deptName}" ได้เนื่องจากยังมีอุปกรณ์อยู่`);
                    return;
                }
                if (confirm(`ต้องการลบแผนก "${deptName}" ใช่หรือไม่?`)) {
                    setDepartmentList(departmentList.filter(d => d !== deptName));
                }
            };

            // --- View Components ---

            const DashboardView = () => {
                const totalAssets = items.length;
                const totalRepairs = items.reduce((sum, item) => sum + item.history.filter(h => h.type === 'repair').length, 0);
                const totalCost = items.reduce((sum, item) => sum + item.history.reduce((hSum, h) => hSum + (h.totalCost || 0), 0), 0);
                
                const mostRepaired = [...items]
                    .map(item => ({
                        ...item,
                        repairCount: item.history.filter(h => h.type === 'repair').length
                    }))
                    .sort((a, b) => b.repairCount - a.repairCount)
                    .filter(item => item.repairCount > 0)
                    .slice(0, 5);

                const partStats = {};
                items.forEach(item => {
                    item.history.forEach(log => {
                        if (log.parts) {
                            log.parts.forEach(part => {
                                const name = part.name.trim();
                                if (!partStats[name]) {
                                    partStats[name] = { count: 0, price: 0, totalSpent: 0 };
                                }
                                partStats[name].count += 1;
                                partStats[name].price = part.price;
                                partStats[name].totalSpent += part.price;
                            });
                        }
                    });
                });

                const topParts = Object.entries(partStats)
                    .map(([name, stats]) => ({ name, ...stats }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);

                return (
                    <div className="space-y-6 animate-fade-in pb-10">
                        <h2 className="text-2xl font-bold text-slate-800 mb-4">ภาพรวมระบบ</h2>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                                <div className="bg-blue-100 p-3 rounded-lg text-blue-600"><Tag size={24} /></div>
                                <div><div className="text-sm text-slate-500">จำนวนอุปกรณ์</div><div className="text-2xl font-bold text-slate-800">{totalAssets}</div></div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                                <div className="bg-orange-100 p-3 rounded-lg text-orange-600"><Wrench size={24} /></div>
                                <div><div className="text-sm text-slate-500">ซ่อมไปแล้ว (ครั้ง)</div><div className="text-2xl font-bold text-slate-800">{totalRepairs}</div></div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                                <div className="bg-red-100 p-3 rounded-lg text-red-600"><DollarSign size={24} /></div>
                                <div><div className="text-sm text-slate-500">ค่าซ่อมสะสม</div><div className="text-2xl font-bold text-slate-800">฿{totalCost.toLocaleString()}</div></div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <AlertTriangle className="text-orange-500" size={20} /> อุปกรณ์ที่ซ่อมบ่อยที่สุด
                                </h3>
                                {mostRepaired.length > 0 ? (
                                    <div className="space-y-4">
                                        {mostRepaired.map((item, index) => (
                                            <div key={item.id} className="relative">
                                                <div className="flex justify-between text-sm mb-1">
                                                    <span className="font-medium text-slate-700">{index + 1}. {item.name} ({item.location})</span>
                                                    <span className="font-bold text-orange-600">{item.repairCount} ครั้ง</span>
                                                </div>
                                                <div className="w-full bg-slate-100 rounded-full h-2.5">
                                                    <div className="bg-orange-500 h-2.5 rounded-full" style={{ width: `${(item.repairCount / mostRepaired[0].repairCount) * 100}%` }}></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-10 text-slate-400">ยังไม่มีข้อมูลการซ่อม</div>
                                )}
                            </div>

                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                    <Package className="text-blue-500" size={20} /> สถิติอะไหล่ที่เปลี่ยนบ่อย (Top 10)
                                </h3>
                                <div className="overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="text-xs text-slate-500 uppercase bg-slate-50">
                                            <tr>
                                                <th className="px-3 py-3 rounded-tl-lg">อันดับ</th>
                                                <th className="px-3 py-3">ชื่ออะไหล่</th>
                                                <th className="px-3 py-3 text-center">จำนวน</th>
                                                <th className="px-3 py-3 text-right rounded-tr-lg">ราคาล่าสุด</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {topParts.length > 0 ? (
                                                topParts.map((part, index) => (
                                                    <tr key={index} className="border-b border-slate-100 hover:bg-slate-50">
                                                        <td className="px-3 py-3 font-medium text-slate-900">{index + 1}</td>
                                                        <td className="px-3 py-3 text-slate-700 font-medium">{part.name}</td>
                                                        <td className="px-3 py-3 text-center">
                                                            <span className="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                                                                {part.count}
                                                            </span>
                                                        </td>
                                                        <td className="px-3 py-3 text-right text-slate-600">฿{part.price.toLocaleString()}</td>
                                                    </tr>
                                                ))
                                            ) : (
                                                <tr>
                                                    <td colSpan="4" className="text-center py-8 text-slate-400">ยังไม่มีข้อมูลการใช้อะไหล่</td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DepartmentListView = () => {
                const departmentCounts = items.reduce((acc, item) => {
                    const loc = item.location || 'ไม่ระบุ';
                    if (!acc[loc]) acc[loc] = 0;
                    acc[loc]++;
                    return acc;
                }, {});

                return (
                    <div className="animate-fade-in pb-10">
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">เลือกแผนก / สถานที่</h2>
                                <p className="text-xs text-slate-500">จัดการรายชื่อแผนกและอุปกรณ์</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleAddDepartment} className="bg-white text-blue-600 border border-blue-200 px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm hover:bg-blue-50 transition">
                                    <PlusCircle size={20} /> <span className="hidden sm:inline">เพิ่มแผนก</span>
                                </button>
                                <button onClick={() => setView('add')} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg hover:bg-blue-700 transition">
                                    <Plus size={20} /> <span className="hidden sm:inline">เพิ่มอุปกรณ์</span>
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            {departmentList.map(dept => (
                                <div key={dept} onClick={() => { setSelectedDepartment(dept); setView('departmentItems'); }} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-blue-200 transition cursor-pointer flex flex-col items-center text-center gap-3 group relative">
                                    <div className="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors">
                                        <Building2 size={32} />
                                    </div>
                                    <div>
                                        <h3 className="font-bold text-lg text-slate-800">{dept}</h3>
                                        <p className="text-sm text-slate-500">{departmentCounts[dept] || 0} อุปกรณ์</p>
                                    </div>
                                    {(!departmentCounts[dept] || departmentCounts[dept] === 0) && (
                                        <button onClick={(e) => deleteDepartment(dept, e)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 p-2" title="ลบแผนก">
                                            <Trash2 size={16} />
                                        </button>
                                    )}
                                </div>
                            ))}
                            {departmentList.length === 0 && (
                                <div className="col-span-full text-center py-12 text-slate-400">ยังไม่มีแผนก กดปุ่ม "เพิ่มแผนก" เพื่อเริ่มต้น</div>
                            )}
                        </div>
                    </div>
                );
            };

            const DepartmentItemsView = () => {
                const filteredItems = items.filter(item => 
                    (item.location || 'ไม่ระบุ') === selectedDepartment &&
                    (item.name.toLowerCase().includes(searchTerm.toLowerCase()) || item.id.toLowerCase().includes(searchTerm.toLowerCase()))
                );

                return (
                    <div className="animate-fade-in pb-10">
                        <div className="flex items-center gap-2 mb-4">
                            <button onClick={() => setView('departments')} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><ChevronLeft size={24} /></button>
                            <div>
                                <h2 className="text-2xl font-bold text-slate-800">{selectedDepartment}</h2>
                                <p className="text-sm text-slate-500">รายการอุปกรณ์ภายในแผนก</p>
                            </div>
                        </div>

                        <div className="relative mb-6">
                            <input type="text" placeholder="ค้นหาอุปกรณ์ในแผนกนี้..." className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                            <Search className="absolute left-3 top-2.5 text-slate-400" size={18} />
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filteredItems.map(item => (
                                <div key={item.id} onClick={() => { setSelectedItem(item); setView('detail'); }} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer flex gap-4">
                                    <div className="w-20 h-20 bg-slate-200 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden">
                                        {item.image ? (
                                            <img src={item.image} alt={item.name} className="w-full h-full object-cover" />
                                        ) : (
                                            <Camera className="text-slate-400" />
                                        )}
                                    </div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-start">
                                            <h3 className="font-semibold text-slate-800 truncate pr-2">{item.name}</h3>
                                            <span className={`flex-shrink-0 text-[10px] px-2 py-0.5 rounded-full ${item.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {item.status === 'active' ? 'ปกติ' : 'ส่งซ่อม'}
                                            </span>
                                        </div>
                                        <p className="text-xs text-slate-500 mt-1 font-mono">{item.id}</p>
                                        <div className="flex items-center gap-1 mt-1 text-xs text-slate-600">
                                            <Calendar size={12} /> <span className="font-medium text-blue-600">{calculateAge(item.purchaseDate)}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            <div onClick={() => setView('add')} className="bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center text-slate-400 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition cursor-pointer min-h-[120px]">
                                <Plus size={32} className="mb-2"/>
                                <span className="text-sm font-medium">เพิ่มอุปกรณ์ในแผนกนี้</span>
                            </div>
                        </div>
                    </div>
                );
            };

            const AddView = () => {
                const defaultLocation = departmentList.includes(selectedDepartment) ? selectedDepartment : '';
                const [formData, setFormData] = useState({
                    id: generateCode(),
                    name: '', model: '', purchaseDate: new Date().toISOString().split('T')[0],
                    location: defaultLocation, image: null, status: 'active', history: []
                });

                const handleImageChange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadend = () => setFormData({ ...formData, image: reader.result });
                        reader.readAsDataURL(file);
                    }
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    handleAddItem(formData);
                };

                return (
                    <div className="animate-fade-in max-w-2xl mx-auto pb-10">
                        <button onClick={() => setView('departments')} className="text-slate-500 mb-4 flex items-center gap-1 hover:text-slate-700"><ChevronLeft size={20} /> กลับหน้าแผนก</button>
                        <div className="bg-white p-6 rounded-xl shadow-md border border-slate-100">
                            <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Plus className="text-blue-600" /> เพิ่มอุปกรณ์ใหม่</h2>
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div className="flex justify-center mb-6">
                                    <div className="relative">
                                        <div className="w-32 h-32 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden">
                                            {formData.image ? <img src={formData.image} alt="Preview" className="w-full h-full object-cover" /> : <div className="text-center text-slate-400"><Camera size={32} className="mx-auto mb-1" /><span className="text-xs">รูปอุปกรณ์</span></div>}
                                        </div>
                                        <input type="file" accept="image/*" onChange={handleImageChange} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">รหัสอุปกรณ์</label><input type="text" value={formData.id} readOnly className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-500 font-mono" /></div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">วันที่ซื้อ</label><input type="date" required value={formData.purchaseDate} onChange={e => setFormData({...formData, purchaseDate: e.target.value})} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
                                    <div className="md:col-span-2"><label className="block text-sm font-medium text-slate-700 mb-1">ชื่ออุปกรณ์ *</label><input type="text" required placeholder="เช่น MacBook Pro, รถโฟล์คลิฟท์" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">รุ่น / Model</label><input type="text" value={formData.model} onChange={e => setFormData({...formData, model: e.target.value})} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">แผนก / สถานที่ *</label>
                                        <input type="text" required placeholder="พิมพ์เพื่อเพิ่มใหม่ หรือเลือกจากรายการ" value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} className="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" list="departments-list" />
                                        <datalist id="departments-list">{departmentList.map(d => <option key={d} value={d} />)}</datalist>
                                        <p className="text-xs text-slate-500 mt-1">* หากพิมพ์ชื่อแผนกใหม่ ระบบจะสร้างแผนกให้อัตโนมัติ</p>
                                    </div>
                                </div>
                                <button type="submit" className="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 shadow-md transition">บันทึกข้อมูล</button>
                            </form>
                        </div>
                    </div>
                );
            };

            const DetailView = () => {
                const item = selectedItem;
                const [activeTab, setActiveTab] = useState('history');
                const [newLog, setNewLog] = useState({ date: new Date().toISOString().split('T')[0], type: 'repair', description: '', laborCost: 0, parts: [] });
                const [tempPart, setTempPart] = useState({ name: '', supplier: '', price: '', image: null });

                const handlePartImageChange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onloadend = () => setTempPart({ ...tempPart, image: reader.result });
                        reader.readAsDataURL(file);
                    }
                };

                const addPartToLog = () => {
                    if (!tempPart.name) return;
                    setNewLog({ ...newLog, parts: [...newLog.parts, { ...tempPart, price: Number(tempPart.price) || 0 }] });
                    setTempPart({ name: '', supplier: '', price: '', image: null });
                };

                const removePartFromLog = (index) => {
                    const updatedParts = newLog.parts.filter((_, i) => i !== index);
                    setNewLog({ ...newLog, parts: updatedParts });
                };

                const calculateTotal = () => Number(newLog.laborCost) + newLog.parts.reduce((sum, part) => sum + part.price, 0);

                const handleAddLog = (e) => {
                    e.preventDefault();
                    const logEntry = { id: Date.now(), ...newLog, laborCost: Number(newLog.laborCost), totalCost: calculateTotal() };
                    handleUpdateItem({ ...item, history: [logEntry, ...item.history] });
                    setActiveTab('history');
                    setNewLog({ date: new Date().toISOString().split('T')[0], type: 'repair', description: '', laborCost: 0, parts: [] });
                };

                return (
                    <div className="animate-fade-in max-w-5xl mx-auto pb-10">
                        <button onClick={() => setView('departmentItems')} className="text-slate-500 mb-4 flex items-center gap-1 hover:text-slate-700"><ChevronLeft size={20} /> กลับหน้าอุปกรณ์</button>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-1 space-y-4">
                                <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="h-48 bg-slate-200 flex items-center justify-center">
                                        {item.image ? <img src={item.image} alt={item.name} className="w-full h-full object-cover" /> : <Camera size={48} className="text-slate-400" />}
                                    </div>
                                    <div className="p-4">
                                        <h2 className="text-lg font-bold text-slate-800">{item.name}</h2>
                                        <div className="text-sm text-slate-500 font-mono mb-2">{item.id}</div>
                                        <div className="flex gap-2 mb-4"><span className={`text-xs px-2 py-1 rounded-full ${item.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{item.status === 'active' ? 'ใช้งานปกติ' : 'ส่งซ่อม'}</span></div>
                                        <div className="space-y-3 text-sm text-slate-600">
                                            <div className="flex justify-between"><span>รุ่น:</span> <span className="font-medium">{item.model || '-'}</span></div>
                                            <div className="flex justify-between items-start"><span>อายุ:</span> <span className="text-xs text-blue-600 font-medium bg-blue-50 px-2 py-0.5 rounded-full">{calculateAge(item.purchaseDate)}</span></div>
                                            <div className="flex justify-between"><span>สถานที่:</span> <span className="font-medium">{item.location}</span></div>
                                        </div>
                                        <button onClick={() => deleteItem(item.id)} className="w-full mt-6 flex items-center justify-center gap-2 text-red-500 hover:text-red-700 text-sm py-2 border border-red-100 rounded-lg hover:bg-red-50 transition"><Trash2 size={16} /> ลบอุปกรณ์</button>
                                    </div>
                                </div>
                            </div>
                            <div className="md:col-span-2">
                                <div className="bg-white rounded-xl shadow-sm border border-slate-100 min-h-[500px] flex flex-col">
                                    <div className="flex border-b border-slate-100">
                                        <button onClick={() => setActiveTab('history')} className={`flex-1 py-3 text-sm font-medium ${activeTab === 'history' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>ประวัติการซ่อม ({item.history.length})</button>
                                        <button onClick={() => setActiveTab('addLog')} className={`flex-1 py-3 text-sm font-medium ${activeTab === 'addLog' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500 hover:text-slate-700'}`}>+ บันทึกซ่อม/อะไหล่</button>
                                    </div>
                                    <div className="p-4 flex-1 overflow-y-auto">
                                        {activeTab === 'history' ? (
                                            <div className="space-y-6">
                                                {item.history.length === 0 ? <div className="text-center text-slate-400 py-10"><Clock size={32} className="mx-auto mb-2 opacity-50" />ยังไม่มีประวัติการซ่อมบำรุง</div> : item.history.map(log => (
                                                    <div key={log.id} className="border-l-4 border-blue-500 pl-4 py-1 relative">
                                                        <div className="absolute -left-[21px] top-0 bg-white border-2 border-blue-500 rounded-full w-3 h-3"></div>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <h4 className="font-bold text-slate-800 text-lg">{log.description}</h4>
                                                                <div className="flex gap-2 items-center mt-1"><span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-600 uppercase tracking-wide">{log.type}</span><span className="text-xs text-slate-400 flex items-center gap-1"><Clock size={10} /> {log.date}</span></div>
                                                            </div>
                                                            <div className="text-right"><div className="text-lg font-bold text-blue-600">฿{log.totalCost?.toLocaleString()}</div><div className="text-xs text-slate-400">ค่าแรง: ฿{log.laborCost?.toLocaleString()}</div></div>
                                                        </div>
                                                        {log.parts && log.parts.length > 0 && (
                                                            <div className="bg-slate-50 rounded-lg p-3 mt-3 border border-slate-100">
                                                                <h5 className="text-xs font-semibold text-slate-500 mb-2 flex items-center gap-1"><Wrench size={12}/> รายการอะไหล่ ({log.parts.length})</h5>
                                                                <div className="space-y-2">{log.parts.map((part, idx) => (
                                                                    <div key={idx} className="flex justify-between items-start text-sm bg-white p-2 rounded border border-slate-100 shadow-sm">
                                                                        <div className="flex gap-3">
                                                                            <div className="w-10 h-10 bg-slate-200 rounded flex-shrink-0 overflow-hidden">{part.image ? <img src={part.image} alt={part.name} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-slate-400"><ImageIcon size={16}/></div>}</div>
                                                                            <div><div className="font-medium text-slate-700">{part.name}</div><div className="text-xs text-slate-400 flex items-center gap-1"><ShoppingBag size={10} /> {part.supplier || '-'}</div></div>
                                                                        </div>
                                                                        <div className="font-mono text-slate-600 mt-1">฿{part.price?.toLocaleString()}</div>
                                                                    </div>
                                                                ))}</div>
                                                            </div>
                                                        )}
                                                    </div>
                                                ))} 
                                            </div>
                                        ) : (
                                            <form onSubmit={handleAddLog} className="space-y-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="block text-sm font-medium mb-1">วันที่</label><input type="date" required value={newLog.date} onChange={e => setNewLog({...newLog, date: e.target.value})} className="w-full p-2 border rounded-lg" /></div>
                                                    <div><label className="block text-sm font-medium mb-1">ประเภท</label><select value={newLog.type} onChange={e => setNewLog({...newLog, type: e.target.value})} className="w-full p-2 border rounded-lg"><option value="repair">ซ่อมแซม (Repair)</option><option value="maintenance">บำรุงรักษา (Maintenance)</option></select></div>
                                                </div>
                                                <div><label className="block text-sm font-medium mb-1">รายละเอียด</label><textarea required rows="2" value={newLog.description} onChange={e => setNewLog({...newLog, description: e.target.value})} className="w-full p-2 border rounded-lg"></textarea></div>
                                                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                                    <label className="block text-sm font-bold text-blue-800 mb-2 flex items-center gap-2"><Wrench size={16} /> เพิ่มรายการอะไหล่</label>
                                                    <div className="flex gap-2 mb-2 items-end">
                                                        <div className="flex-shrink-0">
                                                            <label className={`w-10 h-10 rounded border flex items-center justify-center cursor-pointer transition ${tempPart.image ? 'border-green-500 bg-green-50 text-green-600' : 'border-slate-300 bg-white text-slate-400 hover:text-blue-600'}`}>
                                                                <input type="file" accept="image/*" onChange={handlePartImageChange} className="hidden" />
                                                                {tempPart.image ? <img src={tempPart.image} className="w-full h-full object-cover rounded" /> : <Camera size={20} />}
                                                            </label>
                                                        </div>
                                                        <input type="text" placeholder="ชื่ออะไหล่" className="flex-1 p-2 text-sm border rounded" value={tempPart.name} onChange={e => setTempPart({...tempPart, name: e.target.value})} />
                                                    </div>
                                                    <div className="flex gap-2 mb-3">
                                                        <input type="text" placeholder="ร้านค้า" className="flex-1 p-2 text-sm border rounded" value={tempPart.supplier} onChange={e => setTempPart({...tempPart, supplier: e.target.value})} />
                                                        <input type="number" placeholder="ราคา" className="w-24 p-2 text-sm border rounded" value={tempPart.price} onChange={e => setTempPart({...tempPart, price: e.target.value})} />
                                                        <button type="button" onClick={addPartToLog} className="bg-blue-600 text-white px-3 rounded hover:bg-blue-700"><Plus size={16} /></button>
                                                    </div>
                                                    {newLog.parts.length > 0 && <div className="space-y-2 bg-white rounded border border-slate-200 p-2">{newLog.parts.map((part, idx) => (
                                                        <div key={idx} className="flex justify-between items-center text-sm p-2 bg-slate-50 rounded border border-slate-100">
                                                            <div className="flex items-center gap-2">{part.image && <img src={part.image} className="w-8 h-8 rounded object-cover border" />}<div><div className="font-medium">{part.name}</div><div className="text-xs text-slate-500">{part.supplier}</div></div></div>
                                                            <div className="flex items-center gap-3"><span className="font-mono">฿{part.price.toLocaleString()}</span><button type="button" onClick={() => removePartFromLog(idx)} className="text-red-400 hover:text-red-600"><Trash2 size={14} /></button></div>
                                                        </div>
                                                    ))}</div>}
                                                </div>
                                                <div><label className="block text-sm font-medium mb-1">ค่าแรงช่าง</label><input type="number" value={newLog.laborCost} onChange={e => setNewLog({...newLog, laborCost: e.target.value})} className="w-full p-2 border rounded-lg" /></div>
                                                <div className="bg-slate-100 p-3 rounded-lg flex justify-between items-center"><span className="font-medium text-slate-600">ยอดรวม</span><span className="text-xl font-bold text-blue-600">฿{calculateTotal().toLocaleString()}</span></div>
                                                <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 shadow-lg flex justify-center items-center gap-2"><Save size={18} /> บันทึก</button>
                                            </form>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
                        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3"><div className="bg-blue-600 text-white p-2 rounded-lg"><FileText size={24} /></div><div><h1 className="font-bold text-lg leading-tight">Asset Tracker</h1><p className="text-xs text-slate-500">ระบบบันทึกประวัติอุปกรณ์</p></div></div>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setView('dashboard')} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition ${view === 'dashboard' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><LayoutDashboard size={16} /> <span className="hidden sm:inline">ภาพรวม</span></button>
                                <button onClick={() => setView('departments')} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition ${['departments', 'departmentItems', 'add', 'detail'].includes(view) ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Building2 size={16} /> <span className="hidden sm:inline">แผนก</span></button>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-5xl mx-auto px-4 pt-6">
                        {view === 'dashboard' && <DashboardView />}
                        {view === 'departments' && <DepartmentListView />}
                        {view === 'departmentItems' && <DepartmentItemsView />}
                        {view === 'add' && <AddView />}
                        {view === 'detail' && <DetailView />}
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
