<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Tracker Pro (Stable Version)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Camera, Plus, Save, Wrench, Clock, FileText, ChevronLeft, Search, Trash2, MapPin, Tag, ShoppingBag, DollarSign, X, LayoutDashboard, List, BarChart3, AlertTriangle, TrendingUp, Calendar, Folder, Image as ImageIcon, Building2, PlusCircle, Package, File as FileIcon, UploadCloud, Loader2, Settings, Lock, Check, RefreshCw, DownloadCloud, Edit, Eye } from 'lucide-react';

        const DEFAULT_CONFIG = {
            scriptUrl: 'https://script.google.com/macros/s/AKfycbxrg3L1Kvzbjh5U0WlFve8ExsGYcC8YTte2qB8Rs5Ckkza4aDjQ4QRFpCtz599s1NdE/exec',
            adminPassword: '888'
        };

        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            if (file.size > 5 * 1024 * 1024) { // Limit 5MB
                alert("‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5MB ‡∏≠‡∏≤‡∏à‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
                reject("File too large");
                return;
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        const generateCode = () => `EQ-${new Date().getFullYear()}-${Math.floor(Math.random() * 10000).toString().padStart(4, '0')}`;
        const calculateAge = (dateString) => {
            if (!dateString) return '-';
            const start = new Date(dateString);
            const end = new Date();
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            if (months < 0) { years--; months += 12; }
            return years > 0 ? `${years} ‡∏õ‡∏µ` : `${months} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`;
        };

        function App() {
            const [view, setView] = useState('dashboard');
            const [config, setConfig] = useState(() => {
                const saved = localStorage.getItem('assetTrackerConfig');
                return saved ? JSON.parse(saved) : DEFAULT_CONFIG;
            });
            
            const [items, setItems] = useState([]); 
            const [departmentList, setDepartmentList] = useState([]);
            const [selectedItem, setSelectedItem] = useState(null);
            const [selectedDepartment, setSelectedDepartment] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            
            const [isLoading, setIsLoading] = useState(false);
            const [isSyncing, setIsSyncing] = useState(false);
            const [showAdminModal, setShowAdminModal] = useState(false);
            const [adminInputPassword, setAdminInputPassword] = useState('');
            const [tempConfig, setTempConfig] = useState(config);
            const [historyModalOpen, setHistoryModalOpen] = useState(false);
            const [selectedLog, setSelectedLog] = useState(null);

            useEffect(() => { if (config.scriptUrl) fetchFromGoogle(); }, []);

            const fetchFromGoogle = async () => {
                if (!config.scriptUrl) return;
                setIsLoading(true);
                try {
                    const response = await fetch(config.scriptUrl);
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        setItems(data);
                        setDepartmentList([...new Set(data.map(i => i.location).filter(Boolean))]);
                    }
                } catch (error) { console.error(error); } finally { setIsLoading(false); }
            };

            const callApi = async (payload) => {
                if (!config.scriptUrl) return alert("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ URL ‡∏Å‡πà‡∏≠‡∏ô");
                setIsSyncing(true);
                try {
                    // ‡πÉ‡∏ä‡πâ POST ‡πÅ‡∏ö‡∏ö no-cors ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö Response ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ)
                    // ‡πÄ‡∏£‡∏≤‡∏à‡∏∂‡∏á‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ setTimeout ‡πÅ‡∏•‡πâ‡∏ß Fetch ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                    await fetch(config.scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    setTimeout(() => { 
                        fetchFromGoogle(); 
                        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà)");
                    }, 4000); // ‡∏£‡∏≠ 4 ‡∏ß‡∏¥ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà
                } catch (error) { 
                    alert("Error: " + error.message); 
                } finally { 
                    setIsSyncing(false); 
                }
            };

            const handleAddItem = (newItem) => {
                callApi({ action: 'save', ...newItem }); 
                setItems(prev => [newItem, ...prev]);
                if(newItem.location) setDepartmentList(prev => [...new Set([...prev, newItem.location])]);
                setView('departmentItems');
            };

            const handleAddLog = (assetId, logData) => {
                callApi({ action: 'save', id: assetId, newLog: logData }); 
            };

            const handleDeleteLog = (assetId, logId) => {
                if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ô‡∏µ‡πâ‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
                    callApi({ action: 'delete_log', assetId, logId });
                    setHistoryModalOpen(false);
                }
            };

            const handleUpdateLog = (assetId, logData) => {
                 callApi({ action: 'update_log', assetId, logData });
                 setHistoryModalOpen(false);
            };

            const LoadingOverlay = () => (
                <div className="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center backdrop-blur-sm">
                    <Loader2 className="animate-spin text-blue-600 mb-2" size={48} />
                    <p className="text-slate-600 font-medium animate-pulse">{isSyncing ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud...'}</p>
                </div>
            );

            const DashboardView = () => (
                <div className="fade-in pb-10 space-y-4">
                    <div className="bg-gradient-to-r from-slate-700 to-slate-900 text-white p-6 rounded-2xl shadow-lg flex justify-between">
                        <div><h2 className="text-2xl font-bold">Asset Manager</h2><p className="text-slate-300">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</p></div>
                        <DownloadCloud size={40} className="text-white/30"/>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-slate-500 text-sm">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div><div className="text-3xl font-bold">{items.length}</div></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm border"><div className="text-slate-500 text-sm">‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</div><div className="text-3xl font-bold text-blue-600">{items.reduce((s,i)=>s+(i.history?.length||0),0)}</div></div>
                    </div>
                </div>
            );

            const DepartmentListView = () => {
                const counts = items.reduce((acc, i) => { acc[i.location] = (acc[i.location] || 0) + 1; return acc; }, {});
                return (
                    <div className="fade-in pb-10 grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div className="col-span-full flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold">‡πÅ‡∏ú‡∏ô‡∏Å</h2>
                            <div className="flex gap-2">
                                <button onClick={() => { const n = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å:"); if(n) setDepartmentList([...departmentList,n]); }} className="btn-secondary text-sm px-3 py-2 rounded border bg-white flex gap-1"><PlusCircle size={16}/> ‡πÅ‡∏ú‡∏ô‡∏Å</button>
                                <button onClick={() => setView('add')} className="btn-primary text-sm px-3 py-2 rounded bg-blue-600 text-white flex gap-1"><Plus size={16}/> ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
                            </div>
                        </div>
                        {departmentList.map(dept => (
                            <div key={dept} onClick={() => { setSelectedDepartment(dept); setView('departmentItems'); }} className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center cursor-pointer hover:border-blue-400 transition">
                                <span className="font-medium flex items-center gap-2"><Building2 className="text-blue-500" size={20}/> {dept}</span>
                                <span className="text-xs bg-slate-100 px-2 py-1 rounded-full">{counts[dept] || 0}</span>
                            </div>
                        ))}
                    </div>
                );
            };

            const DepartmentItemsView = () => {
                const filtered = items.filter(i => i.location === selectedDepartment && (i.name.includes(searchTerm) || i.id.includes(searchTerm)));
                return (
                    <div className="fade-in pb-10">
                        <div className="flex items-center gap-2 mb-4"><button onClick={()=>setView('departments')}><ChevronLeft/></button><h2 className="text-xl font-bold">{selectedDepartment}</h2></div>
                        <input className="w-full p-3 border rounded-xl mb-4 bg-white" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." onChange={e=>setSearchTerm(e.target.value)}/>
                        <div className="space-y-3">
                            {filtered.map(item => (
                                <div key={item.id} onClick={()=>{setSelectedItem(item); setView('detail');}} className="bg-white p-3 rounded-xl border flex gap-3 cursor-pointer hover:shadow-md">
                                    <div className="w-20 h-20 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0">
                                        {item.image ? <img src={item.image} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-slate-300"><ImageIcon/></div>}
                                    </div>
                                    <div className="flex-1">
                                        <div className="flex justify-between"><h3 className="font-bold">{item.name}</h3><span className={`text-[10px] px-2 py-0.5 rounded-full ${item.status==='active'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{item.status}</span></div>
                                        <div className="text-xs text-slate-500">{item.id}</div>
                                        {item.receiptPdf && <span className="text-xs text-orange-500 flex items-center gap-1 mt-1"><FileIcon size={12}/> PDF</span>}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const DetailView = () => {
                const item = selectedItem;
                const [log, setLog] = useState({ id: Date.now(), date: new Date().toISOString().split('T')[0], type: 'repair', description: '', laborCost: 0, parts: [] });
                const [part, setPart] = useState({ name: '', price: 0, image: null, receiptPdf: null });

                const handlePartFile = async (e, k) => { if(e.target.files[0]) setPart({...part, [k]: await fileToBase64(e.target.files[0])}) };

                const saveLog = () => {
                    const newLog = { ...log, id: Date.now(), totalCost: Number(log.laborCost) + log.parts.reduce((s,p)=>s+Number(p.price),0) };
                    handleAddLog(item.id, newLog);
                    setLog({ id: Date.now(), date: new Date().toISOString().split('T')[0], type: 'repair', description: '', laborCost: 0, parts: [] });
                };

                return (
                    <div className="fade-in max-w-2xl mx-auto pb-20">
                        <button onClick={() => setView('departmentItems')} className="mb-4 flex items-center gap-1 text-slate-500"><ChevronLeft size={20}/> ‡∏Å‡∏•‡∏±‡∏ö</button>
                        
                        <div className="bg-white rounded-2xl shadow-sm border overflow-hidden mb-6">
                            <div className="h-64 bg-slate-200 relative">
                                {item.image ? <img src={item.image} className="w-full h-full object-cover"/> : <div className="flex items-center justify-center h-full text-slate-300"><ImageIcon size={64}/></div>}
                                <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/70 to-transparent p-6 pt-20 text-white">
                                    <h1 className="text-2xl font-bold">{item.name}</h1>
                                    <p className="text-sm opacity-80">{item.id}</p>
                                </div>
                            </div>
                            <div className="p-6 space-y-4">
                                <div className="grid grid-cols-2 gap-4 text-sm">
                                    <div><label className="text-xs text-slate-500">‡∏£‡∏∏‡πà‡∏ô</label><div>{item.model||'-'}</div></div>
                                    <div><label className="text-xs text-slate-500">‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏∑‡πà‡∏≠</label><div>{item.purchaseDate}</div></div>
                                    <div><label className="text-xs text-slate-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</label><div>{item.location}</div></div>
                                    <div><label className="text-xs text-slate-500">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label><div className={item.status==='active'?'text-green-600':'text-red-600'}>{item.status}</div></div>
                                </div>
                                {item.receiptPdf && <a href={item.receiptPdf} target="_blank" className="block w-full text-center bg-orange-50 text-orange-700 p-3 rounded-lg border border-orange-100 text-sm">üìÑ ‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF</a>}
                            </div>
                        </div>

                        <div className="space-y-4">
                            <h3 className="font-bold text-lg text-slate-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏° ({item.history?.length || 0})</h3>
                            
                            <div className="bg-white p-4 rounded-xl border shadow-sm space-y-3">
                                <h4 className="text-sm font-bold text-slate-600">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà</h4>
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="date" className="border p-2 rounded text-sm" value={log.date} onChange={e=>setLog({...log, date:e.target.value})}/>
                                    <select className="border p-2 rounded text-sm" onChange={e=>setLog({...log, type:e.target.value})}><option value="repair">‡∏ã‡πà‡∏≠‡∏°</option><option value="maintenance">‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤</option></select>
                                </div>
                                <textarea className="w-full border p-2 rounded text-sm" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." value={log.description} onChange={e=>setLog({...log, description:e.target.value})}></textarea>
                                
                                <div className="bg-slate-50 p-3 rounded border">
                                    <div className="flex gap-2 mb-2 text-sm">
                                        <input className="flex-1 border p-1 rounded" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà" value={part.name} onChange={e=>setPart({...part, name:e.target.value})}/>
                                        <input className="w-20 border p-1 rounded" type="number" placeholder="‡∏ö‡∏≤‡∏ó" value={part.price} onChange={e=>setPart({...part, price:e.target.value})}/>
                                    </div>
                                    <div className="flex gap-2 text-xs mb-2">
                                         <label className={`flex-1 border py-1 text-center rounded cursor-pointer ${part.image?'bg-green-100 text-green-700':'bg-white'}`}>{part.image ? '‚úì ‡∏£‡∏π‡∏õ' : '+ ‡∏£‡∏π‡∏õ'} <input type="file" className="hidden" accept="image/*" onChange={e=>handlePartFile(e,'image')}/></label>
                                         <label className={`flex-1 border py-1 text-center rounded cursor-pointer ${part.receiptPdf?'bg-green-100 text-green-700':'bg-white'}`}>{part.receiptPdf ? '‚úì PDF' : '+ PDF'} <input type="file" className="hidden" accept="application/pdf" onChange={e=>handlePartFile(e,'receiptPdf')}/></label>
                                         <button onClick={()=>{if(part.name){setLog({...log, parts:[...log.parts, part]}); setPart({name:'',price:0,image:null,receiptPdf:null})}}} className="bg-blue-600 text-white px-3 rounded">+</button>
                                    </div>
                                    {log.parts.map((p,i)=><div key={i} className="text-xs flex justify-between px-1 bg-white border mb-1 rounded p-1">{p.name} <span>{p.price}</span></div>)}
                                </div>
                                
                                <input type="number" className="w-full border p-2 rounded text-sm" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á" value={log.laborCost} onChange={e=>setLog({...log, laborCost:e.target.value})}/>
                                <button onClick={saveLog} className="w-full bg-slate-800 text-white py-2 rounded font-medium text-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            </div>

                            <div className="space-y-3">
                                {item.history && item.history.map((h) => (
                                    <div key={h.id} onClick={() => { setSelectedLog(h); setHistoryModalOpen(true); }} className="bg-white p-4 rounded-xl border hover:border-blue-400 cursor-pointer transition shadow-sm relative group">
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <div className="font-bold text-slate-800">{h.description}</div>
                                                <div className="text-xs text-slate-500 mt-1">{h.date} ‚Ä¢ <span className="uppercase">{h.type}</span></div>
                                            </div>
                                            <div className="text-right">
                                                <div className="font-bold text-blue-600">‡∏ø{Number(h.totalCost).toLocaleString()}</div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const HistoryModal = () => {
                if (!historyModalOpen || !selectedLog) return null;
                const [editMode, setEditMode] = useState(false);
                const [tempLog, setTempLog] = useState(selectedLog);
                const [tempPart, setTempPart] = useState({ name: '', price: 0, image: null, receiptPdf: null });

                const handleTempPartFile = async (e, k) => { if(e.target.files[0]) setTempPart({...tempPart, [k]: await fileToBase64(e.target.files[0])}) };
                
                const saveEdit = () => {
                    const total = Number(tempLog.laborCost) + (tempLog.parts||[]).reduce((s,p)=>s+Number(p.price),0);
                    handleUpdateLog(selectedItem.id, { ...tempLog, totalCost: total });
                };

                return (
                    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                        <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
                            <div className="bg-slate-50 p-4 border-b flex justify-between items-center sticky top-0">
                                <h3 className="font-bold text-lg">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°</h3>
                                <button onClick={()=>setHistoryModalOpen(false)}><X/></button>
                            </div>
                            <div className="p-6 space-y-4">
                                {!editMode ? (
                                    <>
                                        <div><label className="text-xs text-slate-500">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><div className="font-bold text-lg">{selectedLog.description}</div></div>
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div><label className="text-xs text-slate-500">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><div>{selectedLog.date}</div></div>
                                            <div><label className="text-xs text-slate-500">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><div>{selectedLog.type}</div></div>
                                        </div>
                                        {selectedLog.parts?.length > 0 && (
                                            <div className="bg-slate-50 p-3 rounded-lg border">
                                                <label className="text-xs font-bold text-slate-500 mb-2 block">‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</label>
                                                {selectedLog.parts.map((p, idx) => (
                                                    <div key={idx} className="flex justify-between items-center text-sm py-1 border-b last:border-0 border-slate-200">
                                                        <div className="flex items-center gap-2">
                                                            {p.name}
                                                            {p.image && <a href={p.image} target="_blank" className="text-blue-500"><ImageIcon size={14}/></a>}
                                                            {p.receiptPdf && <a href={p.receiptPdf} target="_blank" className="text-orange-500"><FileIcon size={14}/></a>}
                                                        </div>
                                                        <div className="font-mono">‡∏ø{p.price}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                        <div className="flex justify-between items-center pt-2 border-t">
                                            <span className="text-sm">‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á: ‡∏ø{Number(selectedLog.laborCost).toLocaleString()}</span>
                                            <span className="font-bold text-xl text-blue-600">‡∏£‡∏ß‡∏° ‡∏ø{Number(selectedLog.totalCost).toLocaleString()}</span>
                                        </div>
                                        <div className="grid grid-cols-2 gap-3 pt-4">
                                            <button onClick={()=>setEditMode(true)} className="bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                            <button onClick={()=>handleDeleteLog(selectedItem.id, selectedLog.id)} className="bg-red-50 text-red-600 py-3 rounded-xl font-bold hover:bg-red-100">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="space-y-3">
                                        <div className="bg-yellow-50 text-yellow-800 p-2 text-xs rounded border border-yellow-200">‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
                                        <input type="date" className="w-full border p-2 rounded" value={tempLog.date} onChange={e=>setTempLog({...tempLog, date:e.target.value})}/>
                                        <input className="w-full border p-2 rounded" value={tempLog.description} onChange={e=>setTempLog({...tempLog, description:e.target.value})}/>
                                        <input type="number" className="w-full border p-2 rounded" placeholder="‡∏Ñ‡πà‡∏≤‡πÅ‡∏£‡∏á" value={tempLog.laborCost} onChange={e=>setTempLog({...tempLog, laborCost:e.target.value})}/>
                                        
                                        <div className="bg-slate-50 p-2 rounded border">
                                            <label className="text-xs font-bold mb-1 block">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                                            <div className="flex gap-2 mb-2">
                                                <input className="flex-1 border p-1 rounded text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value={tempPart.name} onChange={e=>setTempPart({...tempPart, name:e.target.value})}/>
                                                <input className="w-16 border p-1 rounded text-sm" type="number" placeholder="‡∏ø" value={tempPart.price} onChange={e=>setTempPart({...tempPart, price:e.target.value})}/>
                                            </div>
                                            <div className="flex gap-2 text-xs mb-2">
                                                 <label className={`flex-1 border py-1 text-center rounded cursor-pointer ${tempPart.image?'bg-green-100':'bg-white'}`}>‡∏£‡∏π‡∏õ <input type="file" className="hidden" accept="image/*" onChange={e=>handleTempPartFile(e,'image')}/></label>
                                                 <label className={`flex-1 border py-1 text-center rounded cursor-pointer ${tempPart.receiptPdf?'bg-green-100':'bg-white'}`}>PDF <input type="file" className="hidden" accept="application/pdf" onChange={e=>handleTempPartFile(e,'receiptPdf')}/></label>
                                                 <button onClick={()=>{if(tempPart.name){setTempLog({...tempLog, parts:[...(tempLog.parts||[]), tempPart]}); setTempPart({name:'',price:0,image:null,receiptPdf:null})}}} className="bg-blue-600 text-white px-3 rounded">+</button>
                                            </div>
                                            {(tempLog.parts||[]).map((p,i)=><div key={i} className="text-xs flex justify-between p-1 bg-white border mb-1 rounded">{p.name} <button onClick={()=>setTempLog({...tempLog, parts:tempLog.parts.filter((_,idx)=>idx!==i)})} className="text-red-500">‡∏•‡∏ö</button></div>)}
                                        </div>

                                        <div className="flex gap-2 pt-2">
                                            <button onClick={saveEdit} className="flex-1 bg-green-600 text-white py-2 rounded font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                                            <button onClick={()=>setEditMode(false)} className="px-4 border rounded text-slate-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            const AddView = () => {
                const [form, setForm] = useState({ id: generateCode(), name: '', location: selectedDepartment || '', purchaseDate: new Date().toISOString().split('T')[0], status: 'active', history: [] });
                const handleFile = async (e, k) => { if(e.target.files[0]) setForm({...form, [k]: await fileToBase64(e.target.files[0])}) };
                return (
                    <div className="fade-in max-w-lg mx-auto pb-10">
                        <button onClick={() => setView('departments')} className="mb-4 flex items-center gap-1 text-slate-500"><ChevronLeft size={20}/> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h2 className="text-xl font-bold mb-6 flex items-center gap-2"><Plus className="text-blue-600"/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà</h2>
                            <form onSubmit={e => { e.preventDefault(); handleAddItem(form); }} className="space-y-4">
                                <div className="w-full h-40 bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl flex items-center justify-center relative overflow-hidden group">
                                    {form.image ? <img src={form.image} className="w-full h-full object-cover"/> : <div className="text-center text-slate-400"><Camera className="mx-auto mb-2" size={32}/><span className="text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏õ (Max 5MB)</span></div>}
                                    <input type="file" onChange={e => handleFile(e, 'image')} className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*"/>
                                </div>
                                <input className="w-full p-2 border rounded-lg" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" required onChange={e => setForm({...form, name: e.target.value})}/>
                                <div className="bg-orange-50 p-4 rounded-xl border border-orange-100">
                                    <label className="flex items-center gap-2 text-orange-800 font-bold text-sm mb-2"><FileIcon size={16}/> ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (PDF)</label>
                                    <input type="file" accept="application/pdf" onChange={e => handleFile(e, 'receiptPdf')} className="block w-full text-sm text-slate-500"/>
                                </div>
                                <button type="submit" disabled={isSyncing} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:bg-slate-300 mt-4">{isSyncing ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}</button>
                            </form>
                        </div>
                    </div>
                );
            };

            const AdminModal = () => (
                showAdminModal ? (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                        <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h3><button onClick={()=>setShowAdminModal(false)}><X/></button></div>
                        {showAdminModal === 'login' ? (
                            <form onSubmit={e => { e.preventDefault(); if(adminInputPassword===config.adminPassword) setShowAdminModal('settings'); else alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î'); }}>
                                <input type="password" autoFocus className="w-full border p-3 rounded-xl mb-4" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (888)" onChange={e=>setAdminInputPassword(e.target.value)}/>
                                <button className="bg-slate-800 text-white w-full py-3 rounded-xl">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                            </form>
                        ) : (
                            <div>
                                <label className="text-xs font-bold uppercase">Web App URL</label>
                                <input className="w-full border p-3 rounded-xl text-xs bg-slate-50 mb-4" value={tempConfig.scriptUrl} onChange={e=>setTempConfig({...tempConfig, scriptUrl:e.target.value})}/>
                                <button onClick={()=>{ setConfig(tempConfig); localStorage.setItem('assetTrackerConfig', JSON.stringify(tempConfig)); setShowAdminModal(false); alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß'); fetchFromGoogle(); }} className="bg-green-600 text-white w-full py-3 rounded-xl font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                            </div>
                        )}
                    </div>
                </div>
                ) : null
            );

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900 pb-20">
                    {isLoading && <LoadingOverlay/>}
                    <header className="bg-white border-b sticky top-0 z-40 px-4 h-16 flex items-center justify-between shadow-sm">
                        <div className="font-bold flex items-center gap-2 text-lg text-slate-800"><div className="bg-blue-600 text-white p-1.5 rounded-lg"><FileText size={20}/></div> Asset Pro</div>
                        <div className="flex gap-2">
                             <button onClick={fetchFromGoogle} className="p-2.5 text-slate-500 hover:bg-slate-100 rounded-full"><RefreshCw size={20}/></button>
                             <button onClick={() => setShowAdminModal('login')} className="p-2.5 text-slate-500 hover:bg-slate-100 rounded-full"><Settings size={20}/></button>
                        </div>
                    </header>
                    <main className="max-w-5xl mx-auto px-4 pt-6">
                        {view === 'dashboard' && <DashboardView />}
                        {view === 'departments' && <DepartmentListView />}
                        {view === 'departmentItems' && <DepartmentItemsView />}
                        {view === 'add' && <AddView />}
                        {view === 'detail' && <DetailView />}
                    </main>
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t h-16 flex justify-around items-center z-30 pb-safe">
                        <button onClick={() => setView('dashboard')} className={`flex flex-col items-center gap-1 text-[10px] ${view==='dashboard'?'text-blue-600':'text-slate-400'}`}><LayoutDashboard size={24}/> <span>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</span></button>
                        <button onClick={() => setView('departments')} className={`flex flex-col items-center gap-1 text-[10px] ${['departments','departmentItems','add','detail'].includes(view)?'text-blue-600':'text-slate-400'}`}><List size={24}/> <span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></button>
                    </nav>
                    <AdminModal/>
                    <HistoryModal/>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
