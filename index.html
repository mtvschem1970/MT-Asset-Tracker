<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Tracker System (Admin Config)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Camera, Plus, Save, Wrench, Clock, FileText, ChevronLeft, Search, Trash2, MapPin, Tag, ShoppingBag, DollarSign, X, LayoutDashboard, List, BarChart3, AlertTriangle, TrendingUp, Calendar, Folder, Image as ImageIcon, Building2, PlusCircle, Package, File as FileIcon, UploadCloud, Loader2, Settings, Lock, Check } from 'lucide-react';

        // --- CONSTANTS ---
        const DEFAULT_CONFIG = {
            scriptUrl: 'https://script.google.com/macros/s/AKfycbxrg3L1Kvzbjh5U0WlFve8ExsGYcC8YTte2qB8Rs5Ckkza4aDjQ4QRFpCtz599s1NdE/exec',
            adminPassword: '888'
        };

        // --- Mock Data ---
        const initialData = [
            {
                id: 'EQ-2023-001',
                name: 'MacBook Pro 16"',
                model: 'M1 Pro',
                image: null,
                receiptPdf: null,
                purchaseDate: '2023-01-15',
                status: 'active',
                location: 'แผนก IT',
                history: []
            }
        ];

        // --- Helper Functions ---
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };

        const generateCode = () => {
            const year = new Date().getFullYear();
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `EQ-${year}-${random}`;
        };

        const calculateAge = (dateString) => {
            if (!dateString) return '-';
            const start = new Date(dateString);
            const end = new Date();
            let years = end.getFullYear() - start.getFullYear();
            let months = end.getMonth() - start.getMonth();
            if (months < 0) { years--; months += 12; }
            if (years < 0) return "ยังไม่ถึงวันใช้งาน";
            let result = [];
            if (years > 0) result.push(`${years} ปี`);
            if (months > 0) result.push(`${months} เดือน`);
            return result.length > 0 ? result.join(' ') : 'เพิ่งซื้อ';
        };

        // --- Main Component ---
        function App() {
            // View State
            const [view, setView] = useState('dashboard');
            const [selectedDepartment, setSelectedDepartment] = useState(null);
            
            // Config State (Load from LocalStorage or Default)
            const [config, setConfig] = useState(() => {
                const savedConfig = localStorage.getItem('assetTrackerConfig');
                return savedConfig ? JSON.parse(savedConfig) : DEFAULT_CONFIG;
            });

            // Admin UI State
            const [showAdminModal, setShowAdminModal] = useState(false); // false, 'login', 'settings'
            const [adminInputPassword, setAdminInputPassword] = useState('');
            const [tempConfig, setTempConfig] = useState(config);

            // Data State
            const [items, setItems] = useState(initialData);
            const [departmentList, setDepartmentList] = useState([...new Set(initialData.map(i => i.location))]);
            const [selectedItem, setSelectedItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [isSyncing, setIsSyncing] = useState(false);

            // --- Admin Logic ---
            const handleAdminLogin = (e) => {
                e.preventDefault();
                if (adminInputPassword === config.adminPassword) {
                    setTempConfig(config); // Load current config to inputs
                    setShowAdminModal('settings');
                    setAdminInputPassword('');
                } else {
                    alert("รหัสผ่านไม่ถูกต้อง");
                }
            };

            const saveConfig = (e) => {
                e.preventDefault();
                setConfig(tempConfig);
                localStorage.setItem('assetTrackerConfig', JSON.stringify(tempConfig));
                alert("บันทึกการตั้งค่าเรียบร้อยแล้ว");
                setShowAdminModal(false);
            };

            // --- Google Sync Logic ---
            const syncToGoogle = async (itemData) => {
                if (!config.scriptUrl || config.scriptUrl.trim() === '') {
                    alert("กรุณาตั้งค่า Web App URL ในเมนู Admin ก่อน");
                    return;
                }

                setIsSyncing(true);
                try {
                    await fetch(config.scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData)
                    });
                    alert(`ข้อมูล ${itemData.name} ถูกส่งไปที่ Google แล้ว (กำลังประมวลผลอยู่เบื้องหลัง)`);
                } catch (error) {
                    console.error("Sync Error:", error);
                    alert("เกิดข้อผิดพลาดในการส่งข้อมูล: " + error.message);
                } finally {
                    setIsSyncing(false);
                }
            };

            // CRUD Actions
            const handleAddItem = (newItem) => {
                setItems([newItem, ...items]);
                if (newItem.location && !departmentList.includes(newItem.location)) {
                    setDepartmentList([...departmentList, newItem.location]);
                }
                if(confirm("บันทึกในเครื่องเสร็จแล้ว ต้องการส่งข้อมูลไป Google Drive/Sheet เลยไหม?")) {
                    syncToGoogle(newItem);
                }
                setSelectedDepartment(newItem.location);
                setView('departmentItems');
            };

            const handleUpdateItem = (updatedItem) => {
                const updatedList = items.map(item => item.id === updatedItem.id ? updatedItem : item);
                setItems(updatedList);
                setSelectedItem(updatedItem);
                if(confirm("บันทึกการแก้ไขแล้ว อัปเดตข้อมูลไปที่ Google ด้วยหรือไม่?")) {
                    syncToGoogle(updatedItem);
                }
            };

            const deleteItem = (id) => {
                if(confirm('ต้องการลบข้อมูลนี้ใช่หรือไม่? (ข้อมูลใน Google Sheet จะไม่ถูกลบอัตโนมัติ)')) {
                    const newItems = items.filter(i => i.id !== id);
                    setItems(newItems);
                    setView('departmentItems');
                    setSelectedItem(null);
                }
            };

            const handleAddDepartment = () => {
                const name = prompt("กรุณาระบุชื่อแผนกใหม่:");
                if (name && name.trim() !== "") {
                    if (!departmentList.includes(name.trim())) {
                        setDepartmentList([...departmentList, name.trim()]);
                    }
                }
            };

            const deleteDepartment = (deptName, e) => {
                e.stopPropagation();
                const hasItems = items.some(i => i.location === deptName);
                if (hasItems) return alert(`ไม่สามารถลบแผนก "${deptName}" ได้เนื่องจากยังมีอุปกรณ์อยู่`);
                if (confirm(`ต้องการลบแผนก "${deptName}" ใช่หรือไม่?`)) setDepartmentList(departmentList.filter(d => d !== deptName));
            };

            // --- Views ---
            const DashboardView = () => {
                const totalAssets = items.length;
                const totalRepairs = items.reduce((sum, item) => sum + item.history.filter(h => h.type === 'repair').length, 0);
                return (
                    <div className="space-y-6 animate-fade-in pb-10">
                         <h2 className="text-2xl font-bold text-slate-800 mb-4">ภาพรวมระบบ</h2>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                                <div className="bg-blue-100 p-3 rounded-lg text-blue-600"><Tag size={24} /></div>
                                <div><div className="text-sm text-slate-500">จำนวนอุปกรณ์</div><div className="text-2xl font-bold text-slate-800">{totalAssets}</div></div>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4">
                                <div className="bg-orange-100 p-3 rounded-lg text-orange-600"><Wrench size={24} /></div>
                                <div><div className="text-sm text-slate-500">ซ่อมไปแล้ว (ครั้ง)</div><div className="text-2xl font-bold text-slate-800">{totalRepairs}</div></div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DepartmentListView = () => {
                 const departmentCounts = items.reduce((acc, item) => {
                    const loc = item.location || 'ไม่ระบุ';
                    acc[loc] = (acc[loc] || 0) + 1;
                    return acc;
                }, {});
                return (
                    <div className="animate-fade-in pb-10">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-slate-800">เลือกแผนก</h2>
                            <div className="flex gap-2">
                                <button onClick={handleAddDepartment} className="bg-white text-blue-600 border border-blue-200 px-4 py-2 rounded-lg flex items-center gap-2 shadow-sm hover:bg-blue-50 transition"><PlusCircle size={20} /> เพิ่มแผนก</button>
                                <button onClick={() => setView('add')} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg hover:bg-blue-700 transition"><Plus size={20} /> เพิ่มอุปกรณ์</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            {departmentList.map(dept => (
                                <div key={dept} onClick={() => { setSelectedDepartment(dept); setView('departmentItems'); }} className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 hover:shadow-md hover:border-blue-200 transition cursor-pointer flex flex-col items-center text-center gap-3 relative group">
                                    <div className="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center group-hover:bg-blue-600 group-hover:text-white transition-colors"><Building2 size={32} /></div>
                                    <div><h3 className="font-bold text-lg text-slate-800">{dept}</h3><p className="text-sm text-slate-500">{departmentCounts[dept] || 0} อุปกรณ์</p></div>
                                    {(!departmentCounts[dept] || departmentCounts[dept] === 0) && (
                                        <button onClick={(e) => deleteDepartment(dept, e)} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 p-2"><Trash2 size={16} /></button>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const DepartmentItemsView = () => {
                const filteredItems = items.filter(item => (item.location || 'ไม่ระบุ') === selectedDepartment && (item.name.toLowerCase().includes(searchTerm.toLowerCase()) || item.id.toLowerCase().includes(searchTerm.toLowerCase())));
                return (
                    <div className="animate-fade-in pb-10">
                        <div className="flex items-center gap-2 mb-4">
                            <button onClick={() => setView('departments')} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><ChevronLeft size={24} /></button>
                            <div><h2 className="text-2xl font-bold text-slate-800">{selectedDepartment}</h2></div>
                        </div>
                        <div className="relative mb-6"><input type="text" placeholder="ค้นหา..." className="w-full pl-10 pr-4 py-2 border rounded-lg" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /><Search className="absolute left-3 top-2.5 text-slate-400" size={18} /></div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {filteredItems.map(item => (
                                <div key={item.id} onClick={() => { setSelectedItem(item); setView('detail'); }} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer flex gap-4">
                                    <div className="w-20 h-20 bg-slate-200 rounded-lg flex-shrink-0 flex items-center justify-center overflow-hidden">{item.image ? <img src={item.image} className="w-full h-full object-cover" /> : <Camera className="text-slate-400" />}</div>
                                    <div className="flex-1 min-w-0">
                                        <div className="flex justify-between items-start"><h3 className="font-semibold text-slate-800 truncate">{item.name}</h3><span className={`text-[10px] px-2 py-0.5 rounded-full ${item.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{item.status === 'active' ? 'ปกติ' : 'ส่งซ่อม'}</span></div>
                                        <p className="text-xs text-slate-500 mt-1 font-mono">{item.id}</p>
                                        <div className="flex items-center gap-1 mt-1 text-xs text-slate-600"><Calendar size={12} /> {calculateAge(item.purchaseDate)}</div>
                                        {item.receiptPdf && <div className="mt-1 flex items-center gap-1 text-[10px] text-orange-600"><FileIcon size={10}/> มีใบเสร็จ</div>}
                                    </div>
                                </div>
                            ))}
                            <div onClick={() => setView('add')} className="bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl p-4 flex flex-col items-center justify-center text-slate-400 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition cursor-pointer min-h-[120px]"><Plus size={32} className="mb-2"/><span className="text-sm font-medium">เพิ่มอุปกรณ์</span></div>
                        </div>
                    </div>
                );
            };

            const AddView = () => {
                const defaultLocation = departmentList.includes(selectedDepartment) ? selectedDepartment : '';
                const [formData, setFormData] = useState({
                    id: generateCode(),
                    name: '', model: '', purchaseDate: new Date().toISOString().split('T')[0],
                    location: defaultLocation, image: null, receiptPdf: null, status: 'active', history: []
                });

                const handleFileChange = async (e, field) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const base64 = await fileToBase64(file);
                            setFormData({ ...formData, [field]: base64 });
                        } catch (err) {
                            alert("เกิดข้อผิดพลาดในการอ่านไฟล์");
                        }
                    }
                };

                return (
                    <div className="animate-fade-in max-w-2xl mx-auto pb-10">
                        <button onClick={() => setView('departments')} className="text-slate-500 mb-4 flex items-center gap-1 hover:text-slate-700"><ChevronLeft size={20} /> กลับ</button>
                        <div className="bg-white p-6 rounded-xl shadow-md border border-slate-100">
                            <h2 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2"><Plus className="text-blue-600" /> เพิ่มอุปกรณ์ใหม่</h2>
                            <form onSubmit={(e) => { e.preventDefault(); handleAddItem(formData); }} className="space-y-4">
                                <div className="flex justify-center mb-6">
                                    <div className="relative">
                                        <div className="w-32 h-32 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center overflow-hidden">
                                            {formData.image ? <img src={formData.image} className="w-full h-full object-cover" /> : <div className="text-center text-slate-400"><Camera size={32} className="mx-auto mb-1" /><span className="text-xs">รูปอุปกรณ์</span></div>}
                                        </div>
                                        <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, 'image')} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">รหัส</label><input type="text" value={formData.id} readOnly className="w-full p-2 bg-slate-50 border rounded-lg font-mono text-slate-500" /></div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">วันที่ซื้อ</label><input type="date" value={formData.purchaseDate} onChange={e => setFormData({...formData, purchaseDate: e.target.value})} className="w-full p-2 border rounded-lg" /></div>
                                    <div className="md:col-span-2"><label className="block text-sm font-medium text-slate-700 mb-1">ชื่ออุปกรณ์ *</label><input type="text" required value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full p-2 border rounded-lg" /></div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">รุ่น</label><input type="text" value={formData.model} onChange={e => setFormData({...formData, model: e.target.value})} className="w-full p-2 border rounded-lg" /></div>
                                    <div>
                                        <label className="block text-sm font-medium text-slate-700 mb-1">แผนก *</label>
                                        <input type="text" required value={formData.location} onChange={e => setFormData({...formData, location: e.target.value})} className="w-full p-2 border rounded-lg" list="departments-list" />
                                        <datalist id="departments-list">{departmentList.map(d => <option key={d} value={d} />)}</datalist>
                                    </div>
                                    
                                    <div className="md:col-span-2 bg-orange-50 p-4 rounded-lg border border-orange-100">
                                        <label className="block text-sm font-medium text-orange-800 mb-1 flex items-center gap-2"><FileIcon size={16}/> ใบเสร็จรับเงิน (PDF) - ไม่บังคับ</label>
                                        <input type="file" accept="application/pdf" onChange={(e) => handleFileChange(e, 'receiptPdf')} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-orange-100 file:text-orange-700 hover:file:bg-orange-200"/>
                                        {formData.receiptPdf && <p className="text-xs text-green-600 mt-1">✓ อัปโหลดไฟล์แล้ว</p>}
                                    </div>
                                </div>
                                <button type="submit" className="w-full mt-6 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 shadow-md">บันทึกข้อมูล</button>
                            </form>
                        </div>
                    </div>
                );
            };

            const DetailView = () => {
                const item = selectedItem;
                const [activeTab, setActiveTab] = useState('history');
                const [newLog, setNewLog] = useState({ date: new Date().toISOString().split('T')[0], type: 'repair', description: '', laborCost: 0, parts: [] });
                const [tempPart, setTempPart] = useState({ name: '', supplier: '', price: '', image: null, receiptPdf: null });

                const handleTempPartFile = async (e, field) => {
                    const file = e.target.files[0];
                    if (file) {
                        const base64 = await fileToBase64(file);
                        setTempPart({ ...tempPart, [field]: base64 });
                    }
                };

                const addPartToLog = () => {
                    if (!tempPart.name) return;
                    setNewLog({ ...newLog, parts: [...newLog.parts, { ...tempPart, price: Number(tempPart.price) || 0 }] });
                    setTempPart({ name: '', supplier: '', price: '', image: null, receiptPdf: null });
                };

                const calculateTotal = () => Number(newLog.laborCost) + newLog.parts.reduce((sum, part) => sum + part.price, 0);

                const handleAddLog = (e) => {
                    e.preventDefault();
                    const logEntry = { id: Date.now(), ...newLog, laborCost: Number(newLog.laborCost), totalCost: calculateTotal() };
                    handleUpdateItem({ ...item, history: [logEntry, ...item.history] });
                    setActiveTab('history');
                    setNewLog({ date: new Date().toISOString().split('T')[0], type: 'repair', description: '', laborCost: 0, parts: [] });
                };

                return (
                    <div className="animate-fade-in max-w-5xl mx-auto pb-10">
                        <button onClick={() => setView('departmentItems')} className="text-slate-500 mb-4 flex items-center gap-1 hover:text-slate-700"><ChevronLeft size={20} /> กลับ</button>
                        
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="md:col-span-1 space-y-4">
                                <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                                    <div className="h-48 bg-slate-200 flex items-center justify-center">
                                        {item.image ? <img src={item.image} className="w-full h-full object-cover" /> : <Camera size={48} className="text-slate-400" />}
                                    </div>
                                    <div className="p-4">
                                        <h2 className="text-lg font-bold text-slate-800">{item.name}</h2>
                                        <div className="text-sm text-slate-500 font-mono mb-2">{item.id}</div>
                                        <div className="space-y-2 text-sm text-slate-600 mt-4">
                                            <div className="flex justify-between"><span>รุ่น:</span> <span className="font-medium">{item.model || '-'}</span></div>
                                            <div className="flex justify-between"><span>สถานที่:</span> <span className="font-medium">{item.location}</span></div>
                                            {item.receiptPdf && (
                                                <div className="bg-orange-50 text-orange-700 p-2 rounded text-xs flex items-center gap-2 mt-2 border border-orange-100">
                                                    <FileIcon size={14}/> มีไฟล์ใบเสร็จบันทึกอยู่
                                                </div>
                                            )}
                                        </div>
                                        
                                        <button onClick={() => syncToGoogle(item)} disabled={isSyncing} className="w-full mt-4 flex items-center justify-center gap-2 bg-green-600 text-white text-sm py-2 rounded-lg hover:bg-green-700 transition">
                                            {isSyncing ? <Loader2 className="animate-spin" size={16}/> : <UploadCloud size={16} />} 
                                            {isSyncing ? 'กำลังส่ง...' : 'Sync to Google'}
                                        </button>

                                        <button onClick={() => deleteItem(item.id)} className="w-full mt-2 flex items-center justify-center gap-2 text-red-500 hover:text-red-700 text-sm py-2 border border-red-100 rounded-lg hover:bg-red-50 transition"><Trash2 size={16} /> ลบอุปกรณ์</button>
                                    </div>
                                </div>
                            </div>

                            <div className="md:col-span-2">
                                <div className="bg-white rounded-xl shadow-sm border border-slate-100 min-h-[500px] flex flex-col">
                                    <div className="flex border-b border-slate-100">
                                        <button onClick={() => setActiveTab('history')} className={`flex-1 py-3 text-sm font-medium ${activeTab === 'history' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>ประวัติการซ่อม</button>
                                        <button onClick={() => setActiveTab('addLog')} className={`flex-1 py-3 text-sm font-medium ${activeTab === 'addLog' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-slate-500'}`}>+ บันทึกซ่อม/อะไหล่</button>
                                    </div>
                                    <div className="p-4 flex-1 overflow-y-auto">
                                        {activeTab === 'history' ? (
                                            <div className="space-y-6">
                                                {item.history.length === 0 ? <div className="text-center text-slate-400 py-10">ยังไม่มีประวัติ</div> : item.history.map(log => (
                                                    <div key={log.id} className="border-l-4 border-blue-500 pl-4 py-1 relative">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div><h4 className="font-bold text-slate-800">{log.description}</h4><div className="text-xs text-slate-400">{log.date} ({log.type})</div></div>
                                                            <div className="text-right font-bold text-blue-600">฿{log.totalCost?.toLocaleString()}</div>
                                                        </div>
                                                        {log.parts && log.parts.length > 0 && (
                                                            <div className="bg-slate-50 rounded p-2 text-sm space-y-2">
                                                                {log.parts.map((p, i) => (
                                                                    <div key={i} className="flex justify-between border-b border-slate-100 pb-1 last:border-0">
                                                                        <span className="flex items-center gap-1">{p.receiptPdf && <FileIcon size={10} className="text-orange-500"/>} {p.name}</span>
                                                                        <span className="text-slate-500">฿{p.price}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <form onSubmit={handleAddLog} className="space-y-4">
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><label className="text-sm">วันที่</label><input type="date" required value={newLog.date} onChange={e => setNewLog({...newLog, date: e.target.value})} className="w-full p-2 border rounded" /></div>
                                                    <div><label className="text-sm">ประเภท</label><select value={newLog.type} onChange={e => setNewLog({...newLog, type: e.target.value})} className="w-full p-2 border rounded"><option value="repair">ซ่อม</option><option value="maintenance">บำรุงรักษา</option></select></div>
                                                </div>
                                                <div><label className="text-sm">รายละเอียด</label><textarea required rows="2" value={newLog.description} onChange={e => setNewLog({...newLog, description: e.target.value})} className="w-full p-2 border rounded"></textarea></div>
                                                
                                                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                                    <label className="text-sm font-bold text-blue-800 mb-2 block">เพิ่มอะไหล่</label>
                                                    <div className="flex gap-2 mb-2">
                                                        <input type="text" placeholder="ชื่ออะไหล่" className="flex-1 p-2 text-sm border rounded" value={tempPart.name} onChange={e => setTempPart({...tempPart, name: e.target.value})} />
                                                        <input type="number" placeholder="ราคา" className="w-24 p-2 text-sm border rounded" value={tempPart.price} onChange={e => setTempPart({...tempPart, price: e.target.value})} />
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 mb-2">
                                                        <input type="text" placeholder="ร้านค้า" className="p-2 text-sm border rounded" value={tempPart.supplier} onChange={e => setTempPart({...tempPart, supplier: e.target.value})} />
                                                        <div className="flex items-center gap-2">
                                                            <label className="cursor-pointer text-xs bg-white border px-2 py-2 rounded flex items-center gap-1 text-slate-500 hover:text-blue-600">
                                                                <Camera size={14}/> รูป
                                                                <input type="file" accept="image/*" className="hidden" onChange={(e) => handleTempPartFile(e, 'image')}/>
                                                            </label>
                                                            <label className="cursor-pointer text-xs bg-white border px-2 py-2 rounded flex items-center gap-1 text-slate-500 hover:text-orange-600">
                                                                <FileIcon size={14}/> ใบเสร็จ PDF
                                                                <input type="file" accept="application/pdf" className="hidden" onChange={(e) => handleTempPartFile(e, 'receiptPdf')}/>
                                                            </label>
                                                            <button type="button" onClick={addPartToLog} className="bg-blue-600 text-white px-3 py-1 rounded text-sm ml-auto">เพิ่ม</button>
                                                        </div>
                                                    </div>
                                                    {(tempPart.image || tempPart.receiptPdf) && <div className="text-[10px] text-green-600 mb-2">ไฟล์พร้อมอัปโหลด: {tempPart.image ? 'รูปภาพ ' : ''} {tempPart.receiptPdf ? 'PDF' : ''}</div>}
                                                    
                                                    {newLog.parts.length > 0 && <div className="space-y-1 bg-white p-2 rounded">{newLog.parts.map((p, i) => (
                                                        <div key={i} className="flex justify-between text-sm"><span className="flex items-center gap-1">{p.receiptPdf && <FileIcon size={10} className="text-orange-500"/>} {p.name}</span><span>฿{p.price}</span></div>
                                                    ))}</div>}
                                                </div>

                                                <div><label className="text-sm">ค่าแรง</label><input type="number" value={newLog.laborCost} onChange={e => setNewLog({...newLog, laborCost: e.target.value})} className="w-full p-2 border rounded" /></div>
                                                <button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 shadow-lg flex justify-center gap-2"><Save size={18} /> บันทึก</button>
                                            </form>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const AdminModal = () => {
                if (!showAdminModal) return null;

                return (
                    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in">
                            <div className="p-4 bg-slate-800 text-white flex justify-between items-center">
                                <h3 className="font-bold flex items-center gap-2"><Settings size={20}/> Admin Configuration</h3>
                                <button onClick={() => setShowAdminModal(false)} className="text-slate-400 hover:text-white"><X size={20}/></button>
                            </div>
                            
                            <div className="p-6">
                                {showAdminModal === 'login' && (
                                    <form onSubmit={handleAdminLogin} className="space-y-4">
                                        <p className="text-slate-600 text-sm mb-4">กรุณาใส่รหัสผ่านเพื่อเข้าสู่การตั้งค่าระบบ</p>
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">รหัสผ่าน Admin</label>
                                            <div className="relative">
                                                <input type="password" autoFocus value={adminInputPassword} onChange={e => setAdminInputPassword(e.target.value)} className="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Default: 888"/>
                                                <Lock className="absolute left-3 top-2.5 text-slate-400" size={16} />
                                            </div>
                                        </div>
                                        <button type="submit" className="w-full bg-slate-800 text-white py-2 rounded-lg font-medium hover:bg-slate-700">เข้าสู่ระบบ</button>
                                    </form>
                                )}

                                {showAdminModal === 'settings' && (
                                    <form onSubmit={saveConfig} className="space-y-4">
                                        <div>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">Google Web App URL</label>
                                            <input type="text" value={tempConfig.scriptUrl} onChange={e => setTempConfig({...tempConfig, scriptUrl: e.target.value})} className="w-full p-2 border rounded-lg text-sm font-mono text-slate-600 break-all" />
                                            <p className="text-[10px] text-slate-400 mt-1">URL ของ Google Apps Script ที่ Deploy แล้ว</p>
                                        </div>
                                        
                                        <div className="pt-4 border-t border-slate-100">
                                            <h4 className="font-medium text-slate-800 mb-2 flex items-center gap-1"><Lock size={14}/> เปลี่ยนรหัสผ่าน Admin</h4>
                                            <label className="block text-sm font-medium text-slate-700 mb-1">รหัสผ่านใหม่</label>
                                            <input type="text" value={tempConfig.adminPassword} onChange={e => setTempConfig({...tempConfig, adminPassword: e.target.value})} className="w-full p-2 border rounded-lg font-mono text-slate-600" />
                                            <p className="text-[10px] text-orange-500 mt-1">คำเตือน: กรุณาจำรหัสผ่านใหม่ให้ได้ หากลืมต้อง Clear Cache Browser</p>
                                        </div>

                                        <button type="submit" className="w-full mt-2 bg-green-600 text-white py-2 rounded-lg font-medium hover:bg-green-700 flex justify-center items-center gap-2"><Check size={18}/> บันทึกการตั้งค่า</button>
                                    </form>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-900">
                    <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
                        <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3"><div className="bg-blue-600 text-white p-2 rounded-lg"><FileText size={24} /></div><div><h1 className="font-bold text-lg leading-tight">Asset Tracker</h1><p className="text-xs text-slate-500">ระบบบันทึกอุปกรณ์ + Google Sync</p></div></div>
                            <div className="flex items-center gap-2">
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button onClick={() => setView('dashboard')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition ${view === 'dashboard' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}><LayoutDashboard size={16} /></button>
                                    <button onClick={() => setView('departments')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition ${['departments', 'departmentItems', 'add', 'detail'].includes(view) ? 'bg-white shadow-sm text-blue-600' : 'text-slate-500'}`}><Building2 size={16} /></button>
                                </div>
                                <button onClick={() => setShowAdminModal('login')} className="p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-100 rounded-full transition" title="ตั้งค่า Admin"><Settings size={20}/></button>
                            </div>
                        </div>
                    </header>
                    <main className="max-w-5xl mx-auto px-4 pt-6">
                        {view === 'dashboard' && <DashboardView />}
                        {view === 'departments' && <DepartmentListView />}
                        {view === 'departmentItems' && <DepartmentItemsView />}
                        {view === 'add' && <AddView />}
                        {view === 'detail' && <DetailView />}
                    </main>
                    
                    <AdminModal />
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
